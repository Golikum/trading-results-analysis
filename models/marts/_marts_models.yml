version: 2

models:
  # Dimension Tables
  - name: dim_client
    description: "Client dimension with standardized segments and validated jurisdictions"
    columns:
      - name: client_id
        description: "Natural key - internal client identifier"
        tests:
          - unique
          - not_null
      - name: client_external_id
        description: "External client identifier used in trading systems"
      - name: jurisdiction
        description: "Regulatory jurisdiction (Unknown for null values)"
        tests:
          - not_null
      - name: segment
        description: "Standardized client business segment (Retail, Pro, VIP)"
        tests:
          - not_null
          - accepted_values:
              values: ['Retail', 'Pro', 'VIP', 'Unknown']
      - name: created_at
        description: "Client creation timestamp"
        tests:
          - not_null
      - name: _loaded_at
        description: "Staging load timestamp"
      - name: _transformed_at
        description: "Dimension transformation timestamp"

  - name: dim_account
    description: "Account dimension with platform and currency details"
    columns:
      - name: account_id
        description: "Natural key - account identifier"
        tests:
          - unique
          - not_null
      - name: platform
        description: "Trading platform (normalized to lowercase)"
        tests:
          - not_null
      - name: client_id
        description: "Foreign key to client dimension"
        tests:
          - not_null
          - relationships:
              to: ref('dim_client')
              field: client_id
      - name: base_currency
        description: "Account base currency (normalized to uppercase)"
        tests:
          - not_null
      - name: created_at
        description: "Account creation timestamp"
        tests:
          - not_null
      - name: closed_at
        description: "Account closure timestamp (null if still active)"
      - name: salesforce_account_id
        description: "Salesforce account identifier"
      - name: is_system
        description: "System account flag"
        tests:
          - not_null
      - name: is_deleted
        description: "Deleted account flag"
        tests:
          - not_null
      - name: account_status
        description: "Derived account status (active, closed, deleted, system)"
        tests:
          - not_null
          - accepted_values:
              values: ['active', 'closed', 'deleted', 'system']
      - name: _loaded_at
        description: "Staging load timestamp"
      - name: _transformed_at
        description: "Dimension transformation timestamp"

  - name: dim_symbol
    description: "Symbol dimension with standardized symbol reference data"
    columns:
      - name: platform
        description: "Trading platform (normalized to lowercase)"
        tests:
          - not_null
      - name: platform_symbol
        description: "Platform-specific symbol identifier"
        tests:
          - not_null
      - name: std_symbol
        description: "Standardized symbol (normalized to uppercase)"
        tests:
          - not_null
      - name: asset_class
        description: "Asset class category"
        tests:
          - not_null
      - name: quote_currency
        description: "Quote currency (normalized to uppercase)"
        tests:
          - not_null
      - name: tick_value
        description: "Minimum price movement value"
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
              inclusive: false
      - name: _loaded_at
        description: "Staging load timestamp"
      - name: _transformed_at
        description: "Dimension transformation timestamp"
    tests:
      - unique:
          column_name: "platform || '_' || platform_symbol"

  - name: dim_dates
    description: "Date dimension for time-based analysis"
    columns:
      - name: date_key
        description: "Date in YYYYMMDD format"
        tests:
          - unique
          - not_null
      - name: date_actual
        description: "Actual date"
        tests:
          - unique
          - not_null
      - name: year
        description: "Year (YYYY)"
      - name: quarter
        description: "Quarter (Q1, Q2, Q3, Q4)"
      - name: month
        description: "Month number (1-12)"
      - name: month_name
        description: "Month name"
      - name: week_of_year
        description: "Week number in year"
      - name: day_of_week
        description: "Day of week (1=Sunday, 7=Saturday)"
      - name: day_name
        description: "Day name"
      - name: is_weekend
        description: "Weekend flag"
      - name: is_holiday
        description: "Holiday flag"

  # Fact Tables
  - name: fact_trades
    description: "Granular trade transactions with enriched performance metrics"
    columns:
      - name: trade_key
        description: "Surrogate key for trade fact"
        tests:
          - unique
          - not_null
      - name: trade_id
        description: "Natural key - trade identifier"
        tests:
          - unique
          - not_null
      - name: account_key
        description: "Foreign key to account dimension"
        tests:
          - not_null
          - relationships:
              to: ref('dim_account')
              field: account_id
      - name: client_key
        description: "Foreign key to client dimension"
        tests:
          - not_null
          - relationships:
              to: ref('dim_client')
              field: client_id
      - name: symbol_key
        description: "Foreign key to symbol dimension"
        tests:
          - not_null
          - relationships:
              to: ref('dim_symbol')
              field: platform || '_' || platform_symbol
      - name: trade_date_key
        description: "Foreign key to date dimension (trade date)"
        tests:
          - not_null
          - relationships:
              to: ref('dim_dates')
              field: date_key
      - name: side
        description: "Trade side (buy/sell)"
        tests:
          - accepted_values:
              values: ['buy', 'sell']
      - name: volume
        description: "Trade volume"
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
              inclusive: false
      - name: open_price
        description: "Trade opening price"
      - name: close_price
        description: "Trade closing price"
      - name: commission
        description: "Commission amount"
      - name: realized_pnl
        description: "Realized profit/loss"
      - name: net_pnl
        description: "Net P&L (realized_pnl + commission)"
      - name: trade_value
        description: "Total trade value (volume * price)"

  - name: fact_account_eod
    description: "Daily account balances and equity positions"
    columns:
      - name: account_eod_key
        description: "Surrogate key for account EOD fact"
        tests:
          - unique
          - not_null
      - name: account_key
        description: "Foreign key to account dimension"
        tests:
          - not_null
          - relationships:
              to: ref('dim_account')
              field: account_id
      - name: client_key
        description: "Foreign key to client dimension"
        tests:
          - not_null
          - relationships:
              to: ref('dim_client')
              field: client_id
      - name: date_key
        description: "Foreign key to date dimension"
        tests:
          - not_null
          - relationships:
              to: ref('dim_dates')
              field: date_key
      - name: balance
        description: "Account balance"
      - name: equity
        description: "Account equity"
      - name: floating_pnl
        description: "Floating/unrealized P&L"
      - name: margin_level
        description: "Margin level percentage"
      - name: equity_high_watermark
        description: "Rolling maximum equity (for drawdown calculation)"
      - name: equity_drawdown
        description: "Current equity drawdown from high watermark"

  - name: fact_client_performance_daily
    description: "Aggregated daily client performance metrics"
    columns:
      - name: client_performance_key
        description: "Surrogate key for client performance fact"
        tests:
          - unique
          - not_null
      - name: client_key
        description: "Foreign key to client dimension"
        tests:
          - not_null
          - relationships:
              to: ref('dim_client')
              field: client_id
      - name: date_key
        description: "Foreign key to date dimension"
        tests:
          - not_null
          - relationships:
              to: ref('dim_dates')
              field: date_key
      - name: total_trades
        description: "Number of trades executed"
      - name: total_volume
        description: "Total trading volume"
      - name: total_commission
        description: "Total commission paid"
      - name: total_realized_pnl
        description: "Total realized P&L"
      - name: net_pnl
        description: "Net P&L for the day"
      - name: avg_trade_size
        description: "Average trade size"
      - name: win_rate
        description: "Percentage of profitable trades"
      - name: largest_win
        description: "Largest winning trade"
      - name: largest_loss
        description: "Largest losing trade"
    tests:
      - unique:
          column_name: "client_key || '_' || date_key"
